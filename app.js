// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇØ„É©„Çπ
class BrainTrainingApp {
    constructor() {
        this.currentScreen = 'loading';
        this.currentGame = null;
        this.gameSession = null;
        this.userData = this.loadUserData();
        this.gameData = {
            games: [
                {id: "janken", name: "ÂæåÂá∫„Åó„Ç∏„É£„É≥„Ç±„É≥", description: "ÊåáÁ§∫„Å´Âæì„Å£„Å¶ÈÅ©Âàá„Å™Êâã„ÇíÈÅ∏„Åº„ÅÜ", icon: "‚úÇÔ∏è"},
                {id: "color-match", name: "„Ç´„É©„Éº„Éû„ÉÉ„ÉÅ", description: "ÊñáÂ≠ó„Å®Ëâ≤„ÅÆ‰∏ÄËá¥„ÇíÁ¥†Êó©„ÅèÂà§Êñ≠", icon: "üé®"},
                {id: "number-memory", name: "Êï∞Â≠óË®òÊÜ∂", description: "Êï∞Â≠ó„ÇíË¶ö„Åà„Å¶È†ÜÁï™„Å´ÈÅ∏Êäû", icon: "üî¢"},
                {id: "calc-quick", name: "Ë®àÁÆó„ÇØ„Ç§„ÉÉ„ÇØ", description: "Á¥†Êó©„ÅèË®àÁÆóÂïèÈ°å„ÇíËß£„Åì„ÅÜ", icon: "‚ûï"},
                {id: "high-low", name: "„Éè„Ç§„Éª„É≠„Éº", description: "Êï∞Â≠ó„ÅÆÂ§ßÂ∞è„Çí‰∫àÊÉ≥„Åó„Çà„ÅÜ", icon: "üìä"},
                {id: "pattern-memory", name: "„Éë„Çø„Éº„É≥Ë®òÊÜ∂", description: "ÂÖâ„ÇãÈ†ÜÁï™„ÇíË¶ö„Åà„Å¶ÂÜçÁèæ", icon: "üîÑ"},
                {id: "reaction-time", name: "ÂèçÂøúÊôÇÈñì„ÉÜ„Çπ„Éà", description: "Ëâ≤„ÅåÂ§â„Çè„Å£„Åü„ÇâÁ¥†Êó©„Åè„Çø„ÉÉ„Éó", icon: "‚ö°"},
                {id: "visual-search", name: "Ë¶ñË¶öÊé¢Á¥¢", description: "ÁâπÂÆö„ÅÆÊñáÂ≠ó„ÇíÁ¥†Êó©„ÅèË¶ã„Å§„Åë„Çà„ÅÜ", icon: "üîç"},
                {id: "dual-nback", name: "„Éá„É•„Ç¢„É´N„Éê„ÉÉ„ÇØ", description: "‰ΩçÁΩÆ„Å®Èü≥„ÇíÂêåÊôÇ„Å´Ë®òÊÜ∂", icon: "üß†"},
                {id: "memory-card", name: "Á•ûÁµåË°∞Âº±", description: "„Ç´„Éº„Éâ„ÅÆ‰ΩçÁΩÆ„ÇíË¶ö„Åà„Å¶„Éö„Ç¢„ÇíË¶ã„Å§„Åë„Çà„ÅÜ", icon: "üÉè"},
                {id: "sequence-memory", name: "È†ÜÁï™Ë®òÊÜ∂", description: "ÂÖâ„ÇãÈ†ÜÁï™„ÇíÊ≠£Á¢∫„Å´Ë¶ö„Åà„Çà„ÅÜ", icon: "üí°"},
                {id: "word-chain", name: "„Åó„Çä„Å®„Çä‚àû", description: "ÂçòË™û„Çí„Å§„Å™„Åí„Å¶Á∂ö„Åë„Çà„ÅÜ", icon: "üî§"}
            ],
            levels: [
                {level: 1, name: "„Éì„ÇÆ„Éä„Éº", requiredPoints: 0, color: "#95a5a6"},
                {level: 2, name: "„Ç¢„Éû„ÉÅ„É•„Ç¢", requiredPoints: 150, color: "#3498db"},
                {level: 3, name: "„Çª„Éü„Éó„É≠", requiredPoints: 400, color: "#2ecc71"},
                {level: 4, name: "„Éó„É≠", requiredPoints: 800, color: "#f39c12"},
                {level: 5, name: "„Ç®„Ç≠„Çπ„Éë„Éº„Éà", requiredPoints: 1500, color: "#e74c3c"},
                {level: 6, name: "„Éû„Çπ„Çø„Éº", requiredPoints: 3000, color: "#9b59b6"}
            ],
            badges: [
                {id: "first-play", name: "ÂàùÂøÉËÄÖ", description: "ÂàùÂõû„Éó„É¨„Ç§ÂÆå‰∫Ü", icon: "üåü"},
                {id: "streak-3", name: "Á∂ôÁ∂öÂäõ", description: "3Êó•ÈÄ£Á∂ö„Éó„É¨„Ç§", icon: "üî•"},
                {id: "streak-7", name: "ÁøíÊÖ£Âåñ", description: "7Êó•ÈÄ£Á∂ö„Éó„É¨„Ç§", icon: "üí™"},
                {id: "perfect-score", name: "„Éë„Éº„Éï„Çß„ÇØ„Éà", description: "„Éé„Éº„Éü„ÇπÂÆå‰∫Ü", icon: "üèÜ"},
                {id: "speed-master", name: "„Çπ„Éî„Éº„ÉâM", description: "Âπ≥ÂùáÂèçÂøú1ÁßíÊú™Ê∫Ä", icon: "‚ö°"},
                {id: "brain-athlete", name: "ËÑ≥„Ç¢„Çπ„É™„Éº„Éà", description: "ÂÖ®„Ç≤„Éº„É†„ÇØ„É™„Ç¢", icon: "ü•á"},
                {id: "level-up", name: "„É¨„Éô„É´„Ç¢„ÉÉ„Éó", description: "„É¨„Éô„É´2Âà∞ÈÅî", icon: "üìà"},
                {id: "dedicated", name: "ÁåÆË∫´ÁöÑ", description: "100Âõû„Éó„É¨„Ç§", icon: "üéØ"}
            ]
        };
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.checkFirstVisit();
        this.updateUI();
        
        // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ
        setTimeout(() => {
            this.hideLoading();
        }, 1500);
    }

    loadUserData() {
        const defaultData = {
            points: 0,
            level: 1,
            streakDays: 0,
            lastPlayDate: null,
            gamesPlayed: 0,
            totalPlayTime: 0,
            badges: [],
            settings: {
                difficulty: 'normal',
                sound: true,
                theme: 'auto'
            },
            gameStats: {},
            dailyStats: {}
        };

        try {
            const saved = localStorage.getItem('brainTrainingData');
            return saved ? {...defaultData, ...JSON.parse(saved)} : defaultData;
        } catch {
            return defaultData;
        }
    }

    saveUserData() {
        try {
            localStorage.setItem('brainTrainingData', JSON.stringify(this.userData));
        } catch (error) {
            console.error('„Éá„Éº„Çø‰øùÂ≠ò„Ç®„É©„Éº:', error);
        }
    }

    checkFirstVisit() {
        if (!this.userData.lastPlayDate) {
            this.currentScreen = 'welcome';
        } else {
            this.currentScreen = 'dashboard';
        }
    }

    hideLoading() {
        document.getElementById('loading-screen').classList.add('hidden');
        
        if (this.currentScreen === 'welcome') {
            document.getElementById('welcome-screen').classList.remove('hidden');
        } else {
            document.getElementById('main-app').classList.remove('hidden');
            this.showScreen('dashboard');
        }
    }

    setupEventListeners() {
        // „Çπ„Çø„Éº„Éà„Éú„Çø„É≥
        document.getElementById('start-btn').addEventListener('click', () => {
            this.userData.lastPlayDate = new Date().toDateString();
            this.saveUserData();
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            this.showScreen('dashboard');
        });

        // „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const screen = btn.dataset.screen;
                this.showScreen(screen);
                this.updateNavigation(screen);
            });
        });

        // „Ç≤„Éº„É†Êàª„Çã„Éú„Çø„É≥
        document.getElementById('back-to-games').addEventListener('click', () => {
            this.showScreen('games');
        });

        // ÁµêÊûúÁîªÈù¢„Éú„Çø„É≥
        document.getElementById('play-again').addEventListener('click', () => {
            this.startGame(this.currentGame);
        });

        document.getElementById('back-to-dashboard').addEventListener('click', () => {
            this.showScreen('dashboard');
        });

        // Áµ±Ë®à„Çø„Éñ
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                this.showTab(tab);
            });
        });

        // „ÉÜ„Éº„ÉûÂàá„ÇäÊõø„Åà
        document.getElementById('theme-toggle').addEventListener('click', () => {
            this.toggleTheme();
        });

        // Ë®≠ÂÆö
        document.getElementById('difficulty-setting').addEventListener('change', (e) => {
            this.userData.settings.difficulty = e.target.value;
            this.saveUserData();
        });

        document.getElementById('sound-setting').addEventListener('change', (e) => {
            this.userData.settings.sound = e.target.checked;
            this.saveUserData();
        });

        document.getElementById('theme-setting').addEventListener('change', (e) => {
            this.userData.settings.theme = e.target.value;
            this.applyTheme();
            this.saveUserData();
        });

        document.getElementById('reset-data').addEventListener('click', () => {
            if (confirm('„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
                localStorage.removeItem('brainTrainingData');
                location.reload();
            }
        });
    }

    showScreen(screenName) {
        // ÂÖ®ÁîªÈù¢„ÇíÈùûË°®Á§∫
        document.querySelectorAll('.app-screen').forEach(screen => {
            screen.classList.add('hidden');
        });

        // ÊåáÂÆöÁîªÈù¢„ÇíË°®Á§∫
        document.getElementById(`${screenName}-screen`).classList.remove('hidden');
        this.currentScreen = screenName;

        // ÁîªÈù¢Âõ∫Êúâ„ÅÆÂá¶ÁêÜ
        switch (screenName) {
            case 'dashboard':
                this.updateDashboard();
                break;
            case 'games':
                this.updateGamesScreen();
                break;
            case 'stats':
                this.updateStatsScreen();
                break;
            case 'settings':
                this.updateSettingsScreen();
                break;
        }
    }

    updateNavigation(activeScreen) {
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-screen="${activeScreen}"]`).classList.add('active');
    }

    updateUI() {
        // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±Êõ¥Êñ∞
        document.getElementById('user-level').textContent = this.userData.level;
        document.getElementById('user-points').textContent = this.userData.points;

        // „Çπ„Éà„É™„Éº„ÇØÊõ¥Êñ∞
        this.updateStreak();
    }

    updateStreak() {
        const today = new Date().toDateString();
        const lastPlay = this.userData.lastPlayDate;
        
        if (lastPlay) {
            const lastDate = new Date(lastPlay);
            const todayDate = new Date(today);
            const diffTime = todayDate.getTime() - lastDate.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 1) {
                // ÈÄ£Á∂öË®òÈå≤Á∂ôÁ∂ö
            } else if (diffDays > 1) {
                this.userData.streakDays = 0;
            }
        }
    }

    updateDashboard() {
        // ‰ªäÊó•„ÅÆÁµ±Ë®à
        const today = new Date().toDateString();
        const todayStats = this.userData.dailyStats[today] || { gamesPlayed: 0, totalReactionTime: 0, gameCount: 0 };
        
        document.getElementById('streak-days').textContent = this.userData.streakDays;
        document.getElementById('today-games').textContent = todayStats.gamesPlayed;
        
        const avgReaction = todayStats.gameCount > 0 ? 
            Math.round(todayStats.totalReactionTime / todayStats.gameCount) : 0;
        document.getElementById('avg-reaction').textContent = avgReaction + 'ms';
        document.getElementById('total-badges').textContent = this.userData.badges.length;

        // „Åä„Åô„Åô„ÇÅ„Ç≤„Éº„É†
        this.renderRecommendedGames();
        this.renderRecentBadges();
    }

    renderRecommendedGames() {
        const container = document.getElementById('recommended-games');
        const recommendedGames = this.gameData.games.slice(0, 4);
        
        container.innerHTML = recommendedGames.map(game => `
            <div class="game-card" onclick="app.startGame('${game.id}')">
                <div class="game-header">
                    <div class="game-icon">${game.icon}</div>
                    <div>
                        <h3 class="game-title">${game.name}</h3>
                        <p class="game-description">${game.description}</p>
                    </div>
                </div>
                <div class="game-stats">
                    <span>„Éó„É¨„Ç§ÂõûÊï∞: ${this.getGamePlayCount(game.id)}</span>
                    <span>ÊúÄÈ´ò„Çπ„Ç≥„Ç¢: ${this.getGameBestScore(game.id)}</span>
                </div>
            </div>
        `).join('');
    }

    renderRecentBadges() {
        const container = document.getElementById('badge-list');
        const recentBadges = this.userData.badges.slice(-3);
        
        if (recentBadges.length === 0) {
            container.innerHTML = '<p class="text-secondary">„Åæ„Å†„Éê„ÉÉ„Ç∏„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
            return;
        }

        container.innerHTML = recentBadges.map(badgeId => {
            const badge = this.gameData.badges.find(b => b.id === badgeId);
            return `
                <div class="badge-item">
                    <span class="badge-icon">${badge.icon}</span>
                    <span>${badge.name}</span>
                </div>
            `;
        }).join('');
    }

    updateGamesScreen() {
        const container = document.getElementById('all-games');
        container.innerHTML = this.gameData.games.map(game => `
            <div class="game-card" onclick="app.startGame('${game.id}')">
                <div class="game-header">
                    <div class="game-icon">${game.icon}</div>
                    <div>
                        <h3 class="game-title">${game.name}</h3>
                        <p class="game-description">${game.description}</p>
                    </div>
                </div>
                <div class="game-stats">
                    <span>„Éó„É¨„Ç§ÂõûÊï∞: ${this.getGamePlayCount(game.id)}</span>
                    <span>ÊúÄÈ´ò„Çπ„Ç≥„Ç¢: ${this.getGameBestScore(game.id)}</span>
                    <span>Âπ≥Âùá„Çπ„Ç≥„Ç¢: ${this.getGameAvgScore(game.id)}</span>
                </div>
            </div>
        `).join('');
    }

    startGame(gameId) {
        this.currentGame = gameId;
        const game = this.gameData.games.find(g => g.id === gameId);
        
        document.getElementById('current-game-title').textContent = game.name;
        this.showScreen('game-play');
        
        // „Ç≤„Éº„É†ÈñãÂßã
        this.gameSession = {
            gameId,
            startTime: Date.now(),
            score: 0,
            correctAnswers: 0,
            totalAnswers: 0,
            reactionTimes: []
        };

        this.initGame(gameId);
    }

    initGame(gameId) {
        const gameContent = document.getElementById('game-content');
        
        switch (gameId) {
            case 'janken':
                this.initJankenGame(gameContent);
                break;
            case 'color-match':
                this.initColorMatchGame(gameContent);
                break;
            case 'number-memory':
                this.initNumberMemoryGame(gameContent);
                break;
            case 'calc-quick':
                this.initCalcQuickGame(gameContent);
                break;
            case 'high-low':
                this.initHighLowGame(gameContent);
                break;
            case 'pattern-memory':
                this.initPatternMemoryGame(gameContent);
                break;
            case 'reaction-time':
                this.initReactionTimeGame(gameContent);
                break;
            case 'visual-search':
                this.initVisualSearchGame(gameContent);
                break;
            case 'dual-nback':
                this.initDualNBackGame(gameContent);
                break;
            case 'memory-card':
                this.initMemoryCardGame(gameContent);
                break;
            case 'sequence-memory':
                this.initSequenceMemoryGame(gameContent);
                break;
            case 'word-chain':
                this.initWordChainGame(gameContent);
                break;
        }

        this.startGameTimer();
    }

    // ÂæåÂá∫„Åó„Ç∏„É£„É≥„Ç±„É≥„Ç≤„Éº„É†
    initJankenGame(container) {
        this.jankenRound = 0;
        this.jankenMaxRounds = 10;
        this.jankenInstructions = ['Âãù„Å§Êâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'Ë≤†„Åë„ÇãÊâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'Âêå„ÅòÊâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ'];
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.jankenMaxRounds}</span>
            </div>
            <div class="game-question" id="janken-instruction">Ê∫ñÂÇô‰∏≠...</div>
            <div class="game-question" id="janken-opponent">?</div>
            <div class="game-options">
                <button class="game-option" onclick="app.jankenAnswer('rock')">‚úä „Ç∞„Éº</button>
                <button class="game-option" onclick="app.jankenAnswer('paper')">‚úã „Éë„Éº</button>
                <button class="game-option" onclick="app.jankenAnswer('scissors')">‚úåÔ∏è „ÉÅ„Éß„Ç≠</button>
            </div>
        `;

        this.nextJankenRound();
    }

    nextJankenRound() {
        if (this.jankenRound >= this.jankenMaxRounds) {
            this.endGame();
            return;
        }

        this.jankenRound++;
        const progress = (this.jankenRound / this.jankenMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.jankenRound}/${this.jankenMaxRounds}`;

        const hands = ['rock', 'paper', 'scissors'];
        const handEmojis = { rock: '‚úä', paper: '‚úã', scissors: '‚úåÔ∏è' };
        const instructions = ['Âãù„Å§Êâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'Ë≤†„Åë„ÇãÊâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'Âêå„ÅòÊâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ'];

        this.currentJankenOpponent = hands[Math.floor(Math.random() * hands.length)];
        this.currentJankenInstruction = instructions[Math.floor(Math.random() * instructions.length)];
        this.jankenStartTime = Date.now();

        document.getElementById('janken-instruction').textContent = this.currentJankenInstruction;
        document.getElementById('janken-opponent').textContent = handEmojis[this.currentJankenOpponent];
    }

    jankenAnswer(playerHand) {
        const reactionTime = Date.now() - this.jankenStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;

        let correct = false;
        const opponent = this.currentJankenOpponent;

        if (this.currentJankenInstruction === 'Âãù„Å§Êâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ') {
            correct = (opponent === 'rock' && playerHand === 'paper') ||
                     (opponent === 'paper' && playerHand === 'scissors') ||
                     (opponent === 'scissors' && playerHand === 'rock');
        } else if (this.currentJankenInstruction === 'Ë≤†„Åë„ÇãÊâã„ÇíÂá∫„Åó„Å¶„Åè„Å†„Åï„ÅÑ') {
            correct = (opponent === 'rock' && playerHand === 'scissors') ||
                     (opponent === 'paper' && playerHand === 'rock') ||
                     (opponent === 'scissors' && playerHand === 'paper');
        } else {
            correct = opponent === playerHand;
        }

        if (correct) {
            this.gameSession.correctAnswers++;
            this.gameSession.score += 10;
        }

        setTimeout(() => this.nextJankenRound(), 500);
    }

    // „Ç´„É©„Éº„Éû„ÉÉ„ÉÅ„Ç≤„Éº„É†
    initColorMatchGame(container) {
        this.colorMatchRound = 0;
        this.colorMatchMaxRounds = 15;
        this.colors = ['Ëµ§', 'Èùí', 'Á∑ë', 'ÈªÑ'];
        this.colorValues = { 'Ëµ§': 'red', 'Èùí': 'blue', 'Á∑ë': 'green', 'ÈªÑ': 'yellow' };
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.colorMatchMaxRounds}</span>
            </div>
            <div class="color-word" id="color-word">Ê∫ñÂÇô‰∏≠...</div>
            <div class="game-options">
                <button class="game-option" onclick="app.colorMatchAnswer(true)">‰∏ÄËá¥</button>
                <button class="game-option" onclick="app.colorMatchAnswer(false)">‰∏ç‰∏ÄËá¥</button>
            </div>
        `;

        this.nextColorMatchRound();
    }

    nextColorMatchRound() {
        if (this.colorMatchRound >= this.colorMatchMaxRounds) {
            this.endGame();
            return;
        }

        this.colorMatchRound++;
        const progress = (this.colorMatchRound / this.colorMatchMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.colorMatchRound}/${this.colorMatchMaxRounds}`;

        const wordColor = this.colors[Math.floor(Math.random() * this.colors.length)];
        const displayColor = this.colors[Math.floor(Math.random() * this.colors.length)];
        
        this.currentColorMatch = wordColor === displayColor;
        this.colorMatchStartTime = Date.now();

        const wordElement = document.getElementById('color-word');
        wordElement.textContent = wordColor;
        wordElement.style.color = this.colorValues[displayColor];
    }

    colorMatchAnswer(answer) {
        const reactionTime = Date.now() - this.colorMatchStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;

        if (answer === this.currentColorMatch) {
            this.gameSession.correctAnswers++;
            this.gameSession.score += 10;
        }

        setTimeout(() => this.nextColorMatchRound(), 300);
    }

    // Êï∞Â≠óË®òÊÜ∂„Ç≤„Éº„É†
    initNumberMemoryGame(container) {
        this.numberMemoryLevel = 3;
        this.numberMemorySequence = [];
        this.numberMemoryPlayerSequence = [];
        this.numberMemoryShowingSequence = false;
        
        container.innerHTML = `
            <div class="game-question">Êï∞Â≠ó„ÇíË¶ö„Åà„Å¶È†ÜÁï™„Å´„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div class="game-question">„É¨„Éô„É´: <span id="memory-level">${this.numberMemoryLevel}</span></div>
            <div class="number-grid" id="number-grid">
                ${Array.from({length: 9}, (_, i) => 
                    `<div class="number-cell" onclick="app.numberMemoryClick(${i + 1})">${i + 1}</div>`
                ).join('')}
            </div>
            <button class="btn btn--primary" onclick="app.startNumberMemoryRound()" id="start-memory">ÈñãÂßã</button>
        `;
    }

    startNumberMemoryRound() {
        this.numberMemorySequence = [];
        this.numberMemoryPlayerSequence = [];
        
        // „É©„É≥„ÉÄ„É†„Å™Êï∞Â≠óÂàó„ÇíÁîüÊàê
        for (let i = 0; i < this.numberMemoryLevel; i++) {
            this.numberMemorySequence.push(Math.floor(Math.random() * 9) + 1);
        }

        document.getElementById('start-memory').style.display = 'none';
        this.showNumberSequence();
    }

    showNumberSequence() {
        this.numberMemoryShowingSequence = true;
        let index = 0;

        const showNext = () => {
            if (index >= this.numberMemorySequence.length) {
                this.numberMemoryShowingSequence = false;
                this.numberMemoryStartTime = Date.now();
                return;
            }

            const number = this.numberMemorySequence[index];
            const cells = document.querySelectorAll('.number-cell');
            
            // Ë©≤ÂΩì„Çª„É´„Çí„Éè„Ç§„É©„Ç§„Éà
            cells[number - 1].classList.add('highlighted');
            
            setTimeout(() => {
                cells[number - 1].classList.remove('highlighted');
                index++;
                setTimeout(showNext, 200);
            }, 600);
        };

        showNext();
    }

    numberMemoryClick(number) {
        if (this.numberMemoryShowingSequence) return;

        this.numberMemoryPlayerSequence.push(number);
        
        // Ê≠£Á≠î„ÉÅ„Çß„ÉÉ„ÇØ
        const currentIndex = this.numberMemoryPlayerSequence.length - 1;
        if (this.numberMemorySequence[currentIndex] !== number) {
            // ÈñìÈÅï„ÅÑ
            this.endGame();
            return;
        }

        // ÂÖ®„Å¶Ê≠£Ëß£„Åó„ÅüÂ†¥Âêà
        if (this.numberMemoryPlayerSequence.length === this.numberMemorySequence.length) {
            const reactionTime = Date.now() - this.numberMemoryStartTime;
            this.gameSession.reactionTimes.push(reactionTime);
            this.gameSession.correctAnswers++;
            this.gameSession.score += this.numberMemoryLevel * 10;
            this.gameSession.totalAnswers++;

            this.numberMemoryLevel++;
            document.getElementById('memory-level').textContent = this.numberMemoryLevel;
            
            if (this.numberMemoryLevel > 8) {
                this.endGame();
                return;
            }

            document.getElementById('start-memory').style.display = 'block';
        }
    }

    // Ë®àÁÆó„ÇØ„Ç§„ÉÉ„ÇØ„Ç≤„Éº„É†
    initCalcQuickGame(container) {
        this.calcRound = 0;
        this.calcMaxRounds = 20;
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.calcMaxRounds}</span>
            </div>
            <div class="game-question" id="calc-question">Ê∫ñÂÇô‰∏≠...</div>
            <div class="game-options" id="calc-options">
                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
        `;

        this.nextCalcRound();
    }

    nextCalcRound() {
        if (this.calcRound >= this.calcMaxRounds) {
            this.endGame();
            return;
        }

        this.calcRound++;
        const progress = (this.calcRound / this.calcMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.calcRound}/${this.calcMaxRounds}`;

        // ÂïèÈ°åÁîüÊàê
        const a = Math.floor(Math.random() * 20) + 1;
        const b = Math.floor(Math.random() * 20) + 1;
        const operations = ['+', '-', '*'];
        const op = operations[Math.floor(Math.random() * operations.length)];
        
        let answer;
        switch (op) {
            case '+': answer = a + b; break;
            case '-': answer = a - b; break;
            case '*': answer = a * b; break;
        }

        this.currentCalcAnswer = answer;
        this.calcStartTime = Date.now();

        document.getElementById('calc-question').textContent = `${a} ${op} ${b} = ?`;

        // ÈÅ∏ÊäûËÇ¢ÁîüÊàê
        const options = [answer];
        while (options.length < 4) {
            const wrong = answer + (Math.floor(Math.random() * 10) - 5);
            if (wrong !== answer && !options.includes(wrong)) {
                options.push(wrong);
            }
        }

        // „Ç∑„É£„ÉÉ„Éï„É´
        for (let i = options.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [options[i], options[j]] = [options[j], options[i]];
        }

        document.getElementById('calc-options').innerHTML = options.map(opt => 
            `<button class="game-option" onclick="app.calcAnswer(${opt})">${opt}</button>`
        ).join('');
    }

    calcAnswer(answer) {
        const reactionTime = Date.now() - this.calcStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;

        if (answer === this.currentCalcAnswer) {
            this.gameSession.correctAnswers++;
            this.gameSession.score += 10;
        }

        setTimeout(() => this.nextCalcRound(), 300);
    }

    // „Éè„Ç§„Éª„É≠„Éº„Ç≤„Éº„É†
    initHighLowGame(container) {
        this.highLowRound = 0;
        this.highLowMaxRounds = 15;
        this.currentNumber = Math.floor(Math.random() * 100) + 1;
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.highLowMaxRounds}</span>
            </div>
            <div class="game-question">ÁèæÂú®„ÅÆÊï∞Â≠ó: <span id="current-number">${this.currentNumber}</span></div>
            <div class="game-question">Ê¨°„ÅÆÊï∞Â≠ó„ÅØÔºü</div>
            <div class="game-options">
                <button class="game-option" onclick="app.highLowAnswer('high')">HIGH (Â§ß„Åç„ÅÑ)</button>
                <button class="game-option" onclick="app.highLowAnswer('low')">LOW (Â∞è„Åï„ÅÑ)</button>
            </div>
        `;

        this.highLowStartTime = Date.now();
    }

    highLowAnswer(guess) {
        const reactionTime = Date.now() - this.highLowStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;

        const nextNumber = Math.floor(Math.random() * 100) + 1;
        const correct = (guess === 'high' && nextNumber > this.currentNumber) ||
                       (guess === 'low' && nextNumber < this.currentNumber);

        if (correct) {
            this.gameSession.correctAnswers++;
            this.gameSession.score += 10;
        }

        this.currentNumber = nextNumber;
        document.getElementById('current-number').textContent = this.currentNumber;

        this.highLowRound++;
        if (this.highLowRound >= this.highLowMaxRounds) {
            setTimeout(() => this.endGame(), 500);
            return;
        }

        const progress = (this.highLowRound / this.highLowMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.highLowRound}/${this.highLowMaxRounds}`;

        this.highLowStartTime = Date.now();
    }

    // „Éë„Çø„Éº„É≥Ë®òÊÜ∂„Ç≤„Éº„É†
    initPatternMemoryGame(container) {
        this.patternLevel = 1;
        this.patternSequence = [];
        this.patternPlayerSequence = [];
        this.patternShowingSequence = false;
        
        container.innerHTML = `
            <div class="game-question">ÂÖâ„ÇãÈ†ÜÁï™„ÇíË¶ö„Åà„Å¶ÂÜçÁèæ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div class="game-question">„É¨„Éô„É´: <span id="pattern-level">${this.patternLevel}</span></div>
            <div class="pattern-grid" id="pattern-grid">
                ${Array.from({length: 9}, (_, i) => 
                    `<div class="pattern-cell" onclick="app.patternClick(${i})"></div>`
                ).join('')}
            </div>
            <button class="btn btn--primary" onclick="app.startPatternRound()" id="start-pattern">ÈñãÂßã</button>
        `;
    }

    startPatternRound() {
        this.patternSequence = [];
        this.patternPlayerSequence = [];
        
        // „É©„É≥„ÉÄ„É†„Å™„Éë„Çø„Éº„É≥„ÇíÁîüÊàê
        for (let i = 0; i < this.patternLevel + 2; i++) {
            this.patternSequence.push(Math.floor(Math.random() * 9));
        }

        document.getElementById('start-pattern').style.display = 'none';
        this.showPatternSequence();
    }

    showPatternSequence() {
        this.patternShowingSequence = true;
        let index = 0;

        const showNext = () => {
            if (index >= this.patternSequence.length) {
                this.patternShowingSequence = false;
                this.patternStartTime = Date.now();
                return;
            }

            const cellIndex = this.patternSequence[index];
            const cells = document.querySelectorAll('.pattern-cell');
            
            cells[cellIndex].classList.add('active');
            
            setTimeout(() => {
                cells[cellIndex].classList.remove('active');
                index++;
                setTimeout(showNext, 200);
            }, 400);
        };

        showNext();
    }

    patternClick(index) {
        if (this.patternShowingSequence) return;

        this.patternPlayerSequence.push(index);
        
        // Ê≠£Á≠î„ÉÅ„Çß„ÉÉ„ÇØ
        const currentIndex = this.patternPlayerSequence.length - 1;
        if (this.patternSequence[currentIndex] !== index) {
            this.endGame();
            return;
        }

        // ÂÖ®„Å¶Ê≠£Ëß£„Åó„ÅüÂ†¥Âêà
        if (this.patternPlayerSequence.length === this.patternSequence.length) {
            const reactionTime = Date.now() - this.patternStartTime;
            this.gameSession.reactionTimes.push(reactionTime);
            this.gameSession.correctAnswers++;
            this.gameSession.score += this.patternLevel * 15;
            this.gameSession.totalAnswers++;

            this.patternLevel++;
            document.getElementById('pattern-level').textContent = this.patternLevel;
            
            if (this.patternLevel > 6) {
                this.endGame();
                return;
            }

            document.getElementById('start-pattern').style.display = 'block';
        }
    }

    // ÂèçÂøúÊôÇÈñì„ÉÜ„Çπ„Éà„Ç≤„Éº„É†
    initReactionTimeGame(container) {
        this.reactionRound = 0;
        this.reactionMaxRounds = 5;
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.reactionMaxRounds}</span>
            </div>
            <div class="game-question" id="reaction-instruction">Ëµ§„ÅÑÂÜÜ„ÅåÁ∑ë„Å´„Å™„Å£„Åü„Çâ„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
            <div class="reaction-target" id="reaction-target" onclick="app.reactionClick()" 
                 style="background-color: red;">ÂæÖÊ©ü‰∏≠...</div>
        `;

        setTimeout(() => this.startReactionRound(), 2000);
    }

    startReactionRound() {
        if (this.reactionRound >= this.reactionMaxRounds) {
            this.endGame();
            return;
        }

        this.reactionRound++;
        const progress = (this.reactionRound / this.reactionMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.reactionRound}/${this.reactionMaxRounds}`;

        const target = document.getElementById('reaction-target');
        const instruction = document.getElementById('reaction-instruction');
        
        target.style.backgroundColor = 'red';
        target.textContent = 'ÂæÖÊ©ü‰∏≠...';
        instruction.textContent = 'Ëµ§„ÅÑÂÜÜ„ÅåÁ∑ë„Å´„Å™„Å£„Åü„Çâ„Çø„ÉÉ„Éó„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        
        this.reactionClickable = false;
        
        // „É©„É≥„ÉÄ„É†„Å™ÊôÇÈñìÂæå„Å´Á∑ë„Å´Â§âÊõ¥
        setTimeout(() => {
            target.style.backgroundColor = 'green';
            target.textContent = '„Çø„ÉÉ„ÉóÔºÅ';
            instruction.textContent = '‰ªä„Åô„Åê„Çø„ÉÉ„ÉóÔºÅ';
            this.reactionStartTime = Date.now();
            this.reactionClickable = true;
        }, Math.random() * 3000 + 1000);
    }

    reactionClick() {
        if (!this.reactionClickable) {
            // „Éï„É©„Ç§„É≥„Ç∞
            document.getElementById('reaction-instruction').textContent = '„Éï„É©„Ç§„É≥„Ç∞ÔºÅÊ¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÇíÂæÖ„Å£„Å¶„Åè„Å†„Åï„ÅÑ';
            setTimeout(() => this.startReactionRound(), 1500);
            return;
        }

        const reactionTime = Date.now() - this.reactionStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;
        this.gameSession.correctAnswers++;
        this.gameSession.score += Math.max(100 - Math.floor(reactionTime / 10), 10);

        const target = document.getElementById('reaction-target');
        target.style.backgroundColor = 'blue';
        target.textContent = `${reactionTime}ms`;
        
        setTimeout(() => this.startReactionRound(), 1500);
    }

    // Ë¶ñË¶öÊé¢Á¥¢„Ç≤„Éº„É†
    initVisualSearchGame(container) {
        this.searchRound = 0;
        this.searchMaxRounds = 10;
        
        container.innerHTML = `
            <div class="game-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 0%"></div>
                </div>
                <span class="progress-text">0/${this.searchMaxRounds}</span>
            </div>
            <div class="game-question">„Çø„Éº„Ç≤„ÉÉ„Éà: <span id="search-target" style="font-weight: bold; color: red;">?</span></div>
            <div class="search-grid" id="search-grid">
                <!-- ÂãïÁöÑ„Å´ÁîüÊàê -->
            </div>
        `;

        this.nextSearchRound();
    }

    nextSearchRound() {
        if (this.searchRound >= this.searchMaxRounds) {
            this.endGame();
            return;
        }

        this.searchRound++;
        const progress = (this.searchRound / this.searchMaxRounds) * 100;
        document.querySelector('.progress-fill').style.width = progress + '%';
        document.querySelector('.progress-text').textContent = `${this.searchRound}/${this.searchMaxRounds}`;

        const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
        const targetLetter = letters[Math.floor(Math.random() * letters.length)];
        const gridSize = 64;
        
        this.currentSearchTarget = targetLetter;
        this.searchStartTime = Date.now();

        document.getElementById('search-target').textContent = targetLetter;

        // „Ç∞„É™„ÉÉ„ÉâÁîüÊàê
        const grid = [];
        // „Çø„Éº„Ç≤„ÉÉ„ÉàÊñáÂ≠ó„Çí3-5ÂÄãÈÖçÁΩÆ
        const targetCount = Math.floor(Math.random() * 3) + 3;
        for (let i = 0; i < targetCount; i++) {
            grid.push(targetLetter);
        }
        
        // ÊÆã„Çä„Çí„É©„É≥„ÉÄ„É†„Å™ÊñáÂ≠ó„ÅßÂüã„ÇÅ„Çã
        while (grid.length < gridSize) {
            const randomLetter = letters[Math.floor(Math.random() * letters.length)];
            if (randomLetter !== targetLetter) {
                grid.push(randomLetter);
            }
        }

        // „Ç∑„É£„ÉÉ„Éï„É´
        for (let i = grid.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [grid[i], grid[j]] = [grid[j], grid[i]];
        }

        document.getElementById('search-grid').innerHTML = grid.map((letter, index) => 
            `<div class="search-char" onclick="app.searchClick('${letter}')">${letter}</div>`
        ).join('');
    }

    searchClick(letter) {
        const reactionTime = Date.now() - this.searchStartTime;
        this.gameSession.reactionTimes.push(reactionTime);
        this.gameSession.totalAnswers++;

        if (letter === this.currentSearchTarget) {
            this.gameSession.correctAnswers++;
            this.gameSession.score += Math.max(50 - Math.floor(reactionTime / 100), 10);
            
            // Ê≠£Ëß£„Åó„Åü„Çª„É´„Çí„Éè„Ç§„É©„Ç§„Éà
            event.target.classList.add('target');
            
            setTimeout(() => this.nextSearchRound(), 800);
        } else {
            // ‰∏çÊ≠£Ëß£
            event.target.style.background = 'red';
            event.target.style.color = 'white';
        }
    }

    // Á∞°Áï•Áâà„Ç≤„Éº„É†ÂÆüË£Ö
    initDualNBackGame(container) {
        container.innerHTML = `
            <div class="game-question">„Éá„É•„Ç¢„É´N„Éê„ÉÉ„ÇØ (Á∞°Áï•Áâà)</div>
            <p>‰ΩçÁΩÆ„Å®Ëâ≤„ÇíÂêåÊôÇ„Å´Ë®òÊÜ∂„Åô„Çã„Ç≤„Éº„É†„Åß„Åô„ÄÇ</p>
            <button class="btn btn--primary" onclick="app.endGame()">ÂÆå‰∫Ü</button>
        `;
        this.gameSession.score = 50;
        this.gameSession.correctAnswers = 5;
        this.gameSession.totalAnswers = 5;
    }

    initMemoryCardGame(container) {
        container.innerHTML = `
            <div class="game-question">Á•ûÁµåË°∞Âº± (Á∞°Áï•Áâà)</div>
            <p>„Ç´„Éº„Éâ„ÅÆ‰ΩçÁΩÆ„ÇíË¶ö„Åà„Å¶„Éö„Ç¢„ÇíË¶ã„Å§„Åë„Çã„Ç≤„Éº„É†„Åß„Åô„ÄÇ</p>
            <button class="btn btn--primary" onclick="app.endGame()">ÂÆå‰∫Ü</button>
        `;
        this.gameSession.score = 60;
        this.gameSession.correctAnswers = 6;
        this.gameSession.totalAnswers = 6;
    }

    initSequenceMemoryGame(container) {
        container.innerHTML = `
            <div class="game-question">È†ÜÁï™Ë®òÊÜ∂ (Á∞°Áï•Áâà)</div>
            <p>ÂÖâ„ÇãÈ†ÜÁï™„ÇíÊ≠£Á¢∫„Å´Ë¶ö„Åà„Çã„Ç≤„Éº„É†„Åß„Åô„ÄÇ</p>
            <button class="btn btn--primary" onclick="app.endGame()">ÂÆå‰∫Ü</button>
        `;
        this.gameSession.score = 55;
        this.gameSession.correctAnswers = 5;
        this.gameSession.totalAnswers = 5;
    }

    initWordChainGame(container) {
        container.innerHTML = `
            <div class="game-question">„Åó„Çä„Å®„Çä‚àû (Á∞°Áï•Áâà)</div>
            <p>ÂçòË™û„Çí„Å§„Å™„Åí„Å¶Á∂ö„Åë„Çã„Ç≤„Éº„É†„Åß„Åô„ÄÇ</p>
            <button class="btn btn--primary" onclick="app.endGame()">ÂÆå‰∫Ü</button>
        `;
        this.gameSession.score = 40;
        this.gameSession.correctAnswers = 4;
        this.gameSession.totalAnswers = 4;
    }

    startGameTimer() {
        this.gameTimer = setInterval(() => {
            const elapsed = Math.floor((Date.now() - this.gameSession.startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('game-timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }, 1000);
    }

    endGame() {
        if (this.gameTimer) {
            clearInterval(this.gameTimer);
        }

        const session = this.gameSession;
        const playTime = Math.floor((Date.now() - session.startTime) / 1000);
        const accuracy = session.totalAnswers > 0 ? 
            Math.round((session.correctAnswers / session.totalAnswers) * 100) : 0;
        const avgReactionTime = session.reactionTimes.length > 0 ? 
            Math.round(session.reactionTimes.reduce((a, b) => a + b, 0) / session.reactionTimes.length) : 0;

        // Áµ±Ë®àÊõ¥Êñ∞
        this.updateGameStats(session.gameId, session.score, accuracy, avgReactionTime, playTime);
        
        // „É¶„Éº„Ç∂„Éº„Éá„Éº„ÇøÊõ¥Êñ∞
        this.userData.points += session.score;
        this.userData.gamesPlayed++;
        this.userData.totalPlayTime += playTime;
        
        // ‰ªäÊó•„ÅÆÁµ±Ë®àÊõ¥Êñ∞
        const today = new Date().toDateString();
        if (!this.userData.dailyStats[today]) {
            this.userData.dailyStats[today] = { gamesPlayed: 0, totalReactionTime: 0, gameCount: 0 };
        }
        this.userData.dailyStats[today].gamesPlayed++;
        this.userData.dailyStats[today].totalReactionTime += avgReactionTime;
        this.userData.dailyStats[today].gameCount++;

        // „Çπ„Éà„É™„Éº„ÇØÊõ¥Êñ∞
        if (this.userData.lastPlayDate !== today) {
            this.userData.streakDays++;
            this.userData.lastPlayDate = today;
        }

        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„ÉÅ„Çß„ÉÉ„ÇØ
        this.checkLevelUp();
        
        // „Éê„ÉÉ„Ç∏„ÉÅ„Çß„ÉÉ„ÇØ
        const newBadges = this.checkBadges(session);

        this.saveUserData();

        // ÁµêÊûúÁîªÈù¢Ë°®Á§∫
        this.showResults(session.score, accuracy, avgReactionTime, newBadges);
    }

    updateGameStats(gameId, score, accuracy, avgReactionTime, playTime) {
        if (!this.userData.gameStats[gameId]) {
            this.userData.gameStats[gameId] = {
                playCount: 0,
                bestScore: 0,
                totalScore: 0,
                totalAccuracy: 0,
                totalReactionTime: 0,
                totalPlayTime: 0
            };
        }

        const stats = this.userData.gameStats[gameId];
        stats.playCount++;
        stats.bestScore = Math.max(stats.bestScore, score);
        stats.totalScore += score;
        stats.totalAccuracy += accuracy;
        stats.totalReactionTime += avgReactionTime;
        stats.totalPlayTime += playTime;
    }

    checkLevelUp() {
        const currentLevel = this.getCurrentLevel();
        if (currentLevel.level > this.userData.level) {
            this.userData.level = currentLevel.level;
            return true;
        }
        return false;
    }

    getCurrentLevel() {
        const levels = this.gameData.levels;
        for (let i = levels.length - 1; i >= 0; i--) {
            if (this.userData.points >= levels[i].requiredPoints) {
                return levels[i];
            }
        }
        return levels[0];
    }

    checkBadges(session) {
        const newBadges = [];
        
        // ÂàùÂõû„Éó„É¨„Ç§„Éê„ÉÉ„Ç∏
        if (this.userData.gamesPlayed === 1 && !this.userData.badges.includes('first-play')) {
            this.userData.badges.push('first-play');
            newBadges.push('first-play');
        }

        // ÈÄ£Á∂ö„Éó„É¨„Ç§„Éê„ÉÉ„Ç∏
        if (this.userData.streakDays >= 3 && !this.userData.badges.includes('streak-3')) {
            this.userData.badges.push('streak-3');
            newBadges.push('streak-3');
        }

        if (this.userData.streakDays >= 7 && !this.userData.badges.includes('streak-7')) {
            this.userData.badges.push('streak-7');
            newBadges.push('streak-7');
        }

        // „Éë„Éº„Éï„Çß„ÇØ„Éà„Çπ„Ç≥„Ç¢„Éê„ÉÉ„Ç∏
        if (session.correctAnswers === session.totalAnswers && session.totalAnswers > 0 && 
            !this.userData.badges.includes('perfect-score')) {
            this.userData.badges.push('perfect-score');
            newBadges.push('perfect-score');
        }

        // „Çπ„Éî„Éº„Éâ„Éû„Çπ„Çø„Éº„Éê„ÉÉ„Ç∏
        const avgReaction = session.reactionTimes.reduce((a, b) => a + b, 0) / session.reactionTimes.length;
        if (avgReaction < 1000 && !this.userData.badges.includes('speed-master')) {
            this.userData.badges.push('speed-master');
            newBadges.push('speed-master');
        }

        // „É¨„Éô„É´„Ç¢„ÉÉ„Éó„Éê„ÉÉ„Ç∏
        if (this.userData.level >= 2 && !this.userData.badges.includes('level-up')) {
            this.userData.badges.push('level-up');
            newBadges.push('level-up');
        }

        // ÁåÆË∫´ÁöÑ„Éê„ÉÉ„Ç∏
        if (this.userData.gamesPlayed >= 100 && !this.userData.badges.includes('dedicated')) {
            this.userData.badges.push('dedicated');
            newBadges.push('dedicated');
        }

        return newBadges;
    }

    showResults(score, accuracy, avgReactionTime, newBadges) {
        document.getElementById('result-score').textContent = score;
        document.getElementById('result-accuracy').textContent = accuracy + '%';
        document.getElementById('result-reaction').textContent = avgReactionTime + 'ms';

        const badgesContainer = document.getElementById('result-badges');
        if (newBadges.length > 0) {
            badgesContainer.innerHTML = '<h3>Êñ∞„Åó„ÅÑ„Éê„ÉÉ„Ç∏Áç≤ÂæóÔºÅ</h3>' + 
                newBadges.map(badgeId => {
                    const badge = this.gameData.badges.find(b => b.id === badgeId);
                    return `<div class="new-badge">${badge.icon} ${badge.name}</div>`;
                }).join('');
        } else {
            badgesContainer.innerHTML = '';
        }

        this.updateUI();
        this.showScreen('result');
    }

    getGamePlayCount(gameId) {
        return this.userData.gameStats[gameId] ? this.userData.gameStats[gameId].playCount : 0;
    }

    getGameBestScore(gameId) {
        return this.userData.gameStats[gameId] ? this.userData.gameStats[gameId].bestScore : 0;
    }

    getGameAvgScore(gameId) {
        const stats = this.userData.gameStats[gameId];
        return stats && stats.playCount > 0 ? 
            Math.round(stats.totalScore / stats.playCount) : 0;
    }

    updateStatsScreen() {
        this.updateOverviewTab();
        this.updateGamesTab();
        this.updateProgressTab();
    }

    updateOverviewTab() {
        document.getElementById('total-play-time').textContent = 
            Math.round(this.userData.totalPlayTime / 60) + 'ÂàÜ';
        document.getElementById('total-games').textContent = this.userData.gamesPlayed;
        
        let bestScore = 0;
        Object.values(this.userData.gameStats).forEach(stats => {
            if (stats.bestScore > bestScore) bestScore = stats.bestScore;
        });
        document.getElementById('best-score').textContent = bestScore;
    }

    updateGamesTab() {
        const container = document.getElementById('game-stats');
        container.innerHTML = this.gameData.games.map(game => {
            const stats = this.userData.gameStats[game.id];
            if (!stats) return '';

            const avgScore = Math.round(stats.totalScore / stats.playCount);
            const avgAccuracy = Math.round(stats.totalAccuracy / stats.playCount);
            const avgReaction = Math.round(stats.totalReactionTime / stats.playCount);

            return `
                <div class="game-stat-item">
                    <div class="game-stat-header">
                        <span class="game-stat-icon">${game.icon}</span>
                        <span class="game-stat-name">${game.name}</span>
                    </div>
                    <div class="game-stat-details">
                        <div class="stat-detail">
                            <div class="stat-detail-value">${stats.playCount}</div>
                            <div class="stat-detail-label">„Éó„É¨„Ç§ÂõûÊï∞</div>
                        </div>
                        <div class="stat-detail">
                            <div class="stat-detail-value">${stats.bestScore}</div>
                            <div class="stat-detail-label">ÊúÄÈ´ò„Çπ„Ç≥„Ç¢</div>
                        </div>
                        <div class="stat-detail">
                            <div class="stat-detail-value">${avgScore}</div>
                            <div class="stat-detail-label">Âπ≥Âùá„Çπ„Ç≥„Ç¢</div>
                        </div>
                        <div class="stat-detail">
                            <div class="stat-detail-value">${avgAccuracy}%</div>
                            <div class="stat-detail-label">Âπ≥ÂùáÊ≠£Á≠îÁéá</div>
                        </div>
                    </div>
                </div>
            `;
        }).filter(html => html).join('');
    }

    updateProgressTab() {
        const container = document.getElementById('progress-chart');
        const days = ['Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü', 'Êó•'];
        const today = new Date();
        const weekData = [];

        for (let i = 6; i >= 0; i--) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            const dateStr = date.toDateString();
            const dayStats = this.userData.dailyStats[dateStr];
            weekData.push({
                day: days[date.getDay()],
                games: dayStats ? dayStats.gamesPlayed : 0
            });
        }

        const maxGames = Math.max(...weekData.map(d => d.games), 1);

        container.innerHTML = `
            <div class="chart-bar">
                ${weekData.map(data => `
                    <div class="bar" style="height: ${(data.games / maxGames) * 100}%"></div>
                `).join('')}
            </div>
            <div class="chart-labels">
                ${weekData.map(data => `
                    <div class="chart-label">${data.day}<br>${data.games}</div>
                `).join('')}
            </div>
        `;
    }

    updateSettingsScreen() {
        document.getElementById('difficulty-setting').value = this.userData.settings.difficulty;
        document.getElementById('sound-setting').checked = this.userData.settings.sound;
        document.getElementById('theme-setting').value = this.userData.settings.theme;
    }

    showTab(tabName) {
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });

        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
        document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-color-scheme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-color-scheme', newTheme);
        
        const themeIcon = document.getElementById('theme-toggle');
        themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    applyTheme() {
        const theme = this.userData.settings.theme;
        if (theme === 'auto') {
            document.documentElement.removeAttribute('data-color-scheme');
        } else {
            document.documentElement.setAttribute('data-color-scheme', theme);
        }
        
        const themeIcon = document.getElementById('theme-toggle');
        const isDark = theme === 'dark' || 
            (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        themeIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
    }
}

// „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñ
let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new BrainTrainingApp();
});

// PWAÈñ¢ÈÄ£
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}